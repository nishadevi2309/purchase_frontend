<div class="view-container">
  <div class="header">
    <h2>Negotiation Details #{{ negotiationId }}</h2>
    <div class="header-buttons">
      <button class="btn btn-edit" (click)="editNegotiation()">
        <i class="fas fa-edit"></i> Edit
      </button>
      <button class="btn-back" (click)="backToList()">
        <i class="fas fa-list"></i> Back to List
      </button>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading">
    <i class="fas fa-spinner fa-spin fa-2x"></i>
    <p>Loading negotiation details...</p>
  </div>

  <div *ngIf="errorMessage" class="alert alert-error">
    <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
  </div>

  <div *ngIf="!isLoading && negotiation" class="details-grid">
    <!-- Negotiation Info Card -->
    <div class="card">
      <h3><i class="fas fa-handshake"></i> Negotiation Information</h3>
      <div class="card-content">
        <div class="detail-row">
          <span class="label">Negotiation ID:</span>
          <span class="value">NEG-{{ negotiation.negotiationid }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Status:</span>
          <span class="value">
            <span class="status-badge" [ngClass]="getStatusClass(negotiation.negotiationstatus)">
              {{ negotiation.negotiationstatus }}
            </span>
          </span>
        </div>
        
        <!-- Approval Date (shown when status is APPROVED) -->
        <div class="detail-row" *ngIf="negotiation.negotiationstatus?.toLowerCase() === 'approved'">
          <span class="label">Date of Approval:</span>
          <span class="value approval-date">
            <i class="fas fa-check-circle"></i>
            {{ getApprovalDate() !== 'Not specified' ? (getApprovalDate() | date:'dd/MM/yyyy') : 'Not specified' }}
          </span>
        </div>

        <!-- Rejection Date (shown when status is REJECTED) -->
        <div class="detail-row" *ngIf="negotiation.negotiationstatus?.toLowerCase() === 'rejected'">
          <span class="label">Date of Rejection:</span>
          <span class="value rejection-date">
            <i class="fas fa-times-circle"></i>
            {{ getRejectionDate() !== 'Not specified' ? (getRejectionDate() | date:'dd/MM/yyyy') : 'Not specified' }}
          </span>
        </div>

        <!-- Rejection Reason (shown when status is REJECTED) -->
        <div class="detail-row" *ngIf="negotiation.negotiationstatus?.toLowerCase() === 'rejected'">
          <span class="label">Reason for Rejection:</span>
          <span class="value rejection-reason">
            <i class="fas fa-comment-alt"></i>
            {{ negotiation.rejectionReason || negotiation.rejectionreason || 'No reason provided' }}
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Negotiation Date:</span>
          <span class="value">{{ negotiation.negotiationDate | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>
    </div>

    <!-- Purchase Request Info Card -->
    <div class="card" *ngIf="negotiation.purchaseRequest">
      <h3><i class="fas fa-file-invoice"></i> Purchase Request</h3>
      <div class="card-content">
        <div class="detail-row">
          <span class="label">PR ID:</span>
          <span class="value">PR-{{ negotiation.purchaseRequest?.prId || 'N/A' }}</span>
        </div>
        <div class="detail-row">
          <span class="label">PR Status:</span>
          <span class="value">
            <span class="status-badge" [ngClass]="getPRStatusClass()">
              {{ getPRStatus() }}
            </span>
            <small *ngIf="negotiation.negotiationstatus?.toLowerCase() === 'approved'" 
                   style="display: block; color: #4caf50; font-size: 0.8em; margin-top: 4px;">
              <i class="fas fa-info-circle"></i> Updated based on negotiation approval
            </small>
          </span>
        </div>
        <div class="detail-row">
          <span class="label">PR Creation Date:</span>
          <span class="value pr-date">
            <i class="fas fa-calendar-plus"></i>
            {{ negotiation.purchaseRequest.requestDate ? (negotiation.purchaseRequest.requestDate | date:'dd/MM/yyyy') : 'N/A' }}
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Allocated Amount:</span>
          <span class="value">₹{{ negotiation.purchaseRequest.allocatedamount ? (negotiation.purchaseRequest.allocatedamount | number:'1.2-2') : 'N/A' }}</span>
        </div>
      </div>
    </div>

    <!-- Vendor & Event Info Card -->
    <div class="card">
      <h3><i class="fas fa-building"></i> Vendor & Event Details</h3>
      <div class="card-content">
        <div class="detail-row">
          <span class="label">Event ID:</span>
          <span class="value">{{ negotiation.eventid }} - {{ getEventName(negotiation.eventid) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Vendor ID:</span>
          <span class="value">{{ negotiation.vendorid }} - {{ getVendorName(negotiation.vendorid) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Vendor Email:</span>
          <span class="value vendor-email">
            <i class="fas fa-envelope"></i>
            {{ getVendorEmail(negotiation.vendorid) }}
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Vendor Phone:</span>
          <span class="value vendor-phone">
            <i class="fas fa-phone"></i>
            {{ getVendorPhone(negotiation.vendorid) }}
          </span>
        </div>
      </div>
    </div>

    <!-- Financial Info Card -->
    <div class="card highlight-card">
      <h3><i class="fas fa-rupee-sign"></i> Financial Details</h3>
      <div class="card-content">
        <div class="detail-row">
          <span class="label">Initial Quote:</span>
          <span class="value amount">₹{{ negotiation.initialquoteamount | number:'1.2-2' }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Final Quote:</span>
          <span class="value amount">
            <span *ngIf="negotiation.finalquoteamount">
              ₹{{ negotiation.finalquoteamount | number:'1.2-2' }}
            </span>
            <span *ngIf="!negotiation.finalquoteamount" class="pending-text">Pending</span>
          </span>
        </div>
        <div class="detail-row savings-row" *ngIf="negotiation.finalquoteamount">
          <!-- Savings (when final quote is less than initial quote) -->
          <div *ngIf="isSavings()" class="savings-container">
            <span class="label">Savings:</span>
            <span class="value savings-value">
              <i class="fas fa-arrow-up"></i>
              ₹{{ getAbsoluteSavings() | number:'1.2-2' }}
              <span class="percentage">({{ getAbsoluteSavingsPercentage() | number:'1.1-1' }}%)</span>
            </span>
          </div>
          
          <!-- Loss (when final quote is more than initial quote) -->
          <div *ngIf="isLoss()" class="loss-container">
            <span class="label">Loss:</span>
            <span class="value loss-value">
              <i class="fas fa-arrow-down"></i>
              ₹{{ getAbsoluteSavings() | number:'1.2-2' }}
              <span class="percentage">({{ getAbsoluteSavingsPercentage() | number:'1.1-1' }}%)</span>
            </span>
          </div>
          
          <!-- No Change (when both quotes are the same) -->
          <div *ngIf="isNoChange()" class="no-change-container">
            <span class="label">Result:</span>
            <span class="value no-change-value">
              <i class="fas fa-equals"></i>
              No Change (0%)
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Comments/Description Card -->
    <div class="card" *ngIf="negotiation.comments">
      <h3><i class="fas fa-comments"></i> Negotiation Comments</h3>
      <div class="card-content">
        <div class="detail-row comments-section">
          <span class="label">Description:</span>
          <div class="comments-content">{{ negotiation.comments }}</div>
        </div>
      </div>
    </div>
  </div>
</div>