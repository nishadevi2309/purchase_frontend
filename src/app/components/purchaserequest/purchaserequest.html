<div class="dashboard-container">
    <header class="dashboard-header">
        <div class="logo">
            <span class="logo-text">PO</span>
            <span class="module-title">Purchase Team Module</span>
        </div>
        <div class="user-info">
            <div class="notifications">
                <i class="fas fa-bell"></i>
                <span class="badge">3</span>
            </div>
            <div class="user-avatar">JD</div>
            <span class="user-name">John Doe</span>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="main-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <nav>
                <ul>
                    <li class="active">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </li>
                    <li (click)="navigateToNegotiateFromSidebar()">
                        <i class="fas fa-comments"></i>
                        <span>Review & Negotiate</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>Finalize PO</span>
                    </li>
                    <li>
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Content Area -->
        <main class="content-area">
            <div class="content-header">
                <h1>Purchase Request Management</h1>
                <p>Create and manage Purchase Requests</p>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" (click)="openRaisePRModal()">
                    <i class="fas fa-plus"></i> Raise PR
                </button>
                <button class="btn btn-info" (click)="loadPurchaseRequests()">
                    <i class="fas fa-refresh"></i> Refresh Data
                </button>
                <button class="btn btn-secondary">
                    <i class="fas fa-download"></i> Export Reports
                </button>
            </div>

            <!-- Metric Cards -->
            <div class="metric-cards">
                <div class="card">
                    <div class="icon-wrapper pending"><i class="fas fa-clock"></i></div>
                    <div class="card-content">
                        <span>PRs Pending</span>
                        <span class="value">{{ pendingCount }}</span>
                    </div>
                </div>
                <div class="card">
                    <div class="icon-wrapper in-progress"><i class="fas fa-comment-dots"></i></div>
                    <div class="card-content">
                        <span>PRs in Negotiation</span>
                        <span class="value">{{ inNegotiationCount }}</span>
                    </div>
                </div>
                <div class="card">
                    <div class="icon-wrapper approved"><i class="fas fa-check-circle"></i></div>
                    <div class="card-content">
                        <span>PRs Approved</span>
                        <span class="value">{{ approvedCount }}</span>
                    </div>
                </div>
                <div class="card">
                    <div class="icon-wrapper failed"><i class="fas fa-times-circle"></i></div>
                    <div class="card-content">
                        <span>PRs Rejected</span>
                        <span class="value">{{ rejectedCount }}</span>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <h3>Purchase Requests</h3>
                
                <!-- Filter Section -->
                <div class="filter-container">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="prIdFilter">PR ID:</label>
                            <input 
                                type="text" 
                                id="prIdFilter"
                                [(ngModel)]="filters.prId" 
                                (input)="onFilterChange()"
                                placeholder="Enter PR ID"
                                class="filter-input">
                        </div>
                        
                        <div class="filter-group">
                            <label for="eventFilter">Event ID/Name:</label>
                            <input 
                                type="text" 
                                id="eventFilter"
                                [(ngModel)]="filters.eventIdOrName" 
                                (input)="onFilterChange()"
                                placeholder="Enter Event ID or Name"
                                class="filter-input">
                        </div>
                        
                        <div class="filter-group">
                            <label for="vendorFilter">Vendor ID/Name:</label>
                            <input 
                                type="text" 
                                id="vendorFilter"
                                [(ngModel)]="filters.vendorIdOrName" 
                                (input)="onFilterChange()"
                                placeholder="Enter Vendor ID or Name"
                                class="filter-input">
                        </div>
                        
                        <div class="filter-group">
                            <label for="statusFilter">Status:</label>
                            <select 
                                id="statusFilter"
                                [(ngModel)]="filters.status" 
                                (change)="onFilterChange()"
                                class="filter-select">
                                <option *ngFor="let option of statusOptions" [value]="option.value">
                                    {{ option.label }}
                                </option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="startAmount">Start Amount (₹):</label>
                            <input 
                                type="number" 
                                id="startAmount"
                                [(ngModel)]="filters.startAmount" 
                                (input)="onFilterChange()"
                                placeholder="Min amount"
                                class="filter-input"
                                min="0">
                        </div>
                        
                        <div class="filter-group">
                            <label for="endAmount">End Amount (₹):</label>
                            <input 
                                type="number" 
                                id="endAmount"
                                [(ngModel)]="filters.endAmount" 
                                (input)="onFilterChange()"
                                placeholder="Max amount"
                                class="filter-input"
                                min="0">
                        </div>
                        
                        <div class="filter-group">
                            <button class="btn btn-secondary" (click)="clearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                        
                        <div class="filter-group">
                            <span class="filter-results">
                                Found {{ totalItems }} result(s)
                            </span>
                        </div>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>PR ID</th>
                            <th>Event ID</th>
                            <th>Vendor ID</th>
                            <th>Allocated Amount</th>
                            <th>PR Status</th>
                            <th>Request Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let pr of paginatedPurchaseRequests; let i = index">
                            <td>{{ pr.prId }}</td>
                            <td>{{ pr.eventId }} - {{ getEventName(pr.eventId) }}</td>
                            <td>{{ pr.vendorId }} - {{ getVendorName(pr.vendorId) }}</td>
                            <td>₹{{ pr.allocatedamount | number:'1.2-2' }}</td>
                            <td>
                                <span class="status-badge" 
                                      [ngClass]="{
                                        'pending': pr.prstatus === 'PENDING',
                                        'in-negotiation': pr.prstatus === 'IN_NEGOTIATION',
                                        'approved': pr.prstatus === 'APPROVED',
                                        'rejected': pr.prstatus === 'REJECTED'
                                      }">
                                    {{ pr.prstatus }}
                                </span>
                            </td>
                            <td>{{ pr.requestLocalDate }}</td>
                            <td>
                                <a href="#" class="action-link" (click)="openViewModal(pr); $event.preventDefault()">View</a>
                                <a href="#" class="action-link" (click)="navigateToNegotiate(pr); $event.preventDefault()">Negotiate</a>
                                <a href="#" class="action-link" (click)="openEditModal(pr); $event.preventDefault()">Edit</a>
                            </td>
                        </tr>
                        <tr *ngIf="paginatedPurchaseRequests.length === 0">
                            <td colspan="7" class="no-data">No Purchase Requests found. Click "Raise PR" to create one.</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Pagination Controls -->
                <div class="pagination-container" *ngIf="totalPages > 1">
                    <div class="pagination-info">
                        <span>Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to {{ getEndIndex() }} of {{ totalItems }} results</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" [disabled]="currentPage === 1" (click)="previousPage()">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        
                        <div class="page-numbers">
                            <button 
                                *ngFor="let page of getPageNumbers()" 
                                class="page-btn" 
                                [class.active]="page === currentPage"
                                (click)="goToPage(page)">
                                {{ page }}
                            </button>
                        </div>
                        
                        <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal for Raise PR (No changes needed here as it's for input) -->
            <div class="modal-overlay" *ngIf="isModalOpen" (click)="closeModal()">
                <div class="modal-content" (click)="$event.stopPropagation()">
                    <div class="modal-header">
                        <h2>Raise Purchase Request</h2>
                        <button class="close-btn" (click)="closeModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="modal-body">
                        <form class="purchase-form">
                            <div class="form-group">
                                <label for="modal-eventId">Event ID:</label>
                                <input 
                                    type="number" 
                                    id="modal-eventId" 
                                    [(ngModel)]="purchaserequest.eventId" 
                                    name="eventId"
                                    placeholder="Enter Event ID"
                                    required>
                            </div>

                            <div class="form-group">
                                <label for="modal-vendorId">Vendor ID:</label>
                                <input 
                                    type="number" 
                                    id="modal-vendorId" 
                                    [(ngModel)]="purchaserequest.vendorId" 
                                    name="vendorId"
                                    placeholder="Enter Vendor ID"
                                    required>
                            </div>

                            <div class="form-group">
                                <label for="modal-allocatedamount">Allocated Amount(INR):</label>
                                <input 
                                    type="number" 
                                    id="modal-allocatedamount" 
                                    [(ngModel)]="purchaserequest.allocatedamount" 
                                    name="allocatedamount"
                                    placeholder="Enter Amount"
                                    step="0.01"
                                    required>
                            </div>
 
                            <div class="form-info">
                                <p><i class="fas fa-info-circle"></i> <strong>Note:</strong> PR Status and Request Date will be automatically set by the system.</p>
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" (click)="addPurchaseRequest()">
                            <i class="fas fa-plus"></i> Raise PR
                        </button>
                        <button type="button" class="btn btn-secondary" (click)="closeModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal for Edit PR Status -->
            <div class="modal-overlay" *ngIf="isEditModalOpen" (click)="closeEditModal()">
                <div class="modal-content" (click)="$event.stopPropagation()">
                    <div class="modal-header">
                        <h2>Edit Purchase Request Status</h2>
                        <button class="close-btn" (click)="closeEditModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="modal-body" *ngIf="currentEditingPR">
                        <div class="pr-details">
                            <h3>Purchase Request Details</h3>
                            <div class="detail-row">
                                <strong>PR ID:</strong> {{ currentEditingPR.prId }}
                            </div>
                            <div class="detail-row">
                                <strong>Event ID:</strong> {{ currentEditingPR.eventId }} - {{ getEventName(currentEditingPR.eventId) }}
                            </div>
                            <div class="detail-row">
                                <strong>Vendor ID:</strong> {{ currentEditingPR.vendorId }} - {{ getVendorName(currentEditingPR.vendorId) }}
                            </div>
                            <div class="detail-row">
                                <strong>Amount:</strong> ₹{{ currentEditingPR.allocatedamount | number:'1.2-2' }}
                            </div>
                            <div class="detail-row">
                                <strong>Request Date:</strong> {{ currentEditingPR.requestLocalDate }}
                            </div>
                            <div class="detail-row">
                                <strong>Current Status:</strong> 
                                <span class="status-badge" 
                                      [ngClass]="{
                                        'pending': currentEditingPR.prstatus === 'PENDING',
                                        'in-negotiation': currentEditingPR.prstatus === 'IN_NEGOTIATION',
                                        'approved': currentEditingPR.prstatus === 'APPROVED',
                                        'rejected': currentEditingPR.prstatus === 'REJECTED'
                                      }">
                                    {{ currentEditingPR.prstatus }}
                                </span>
                            </div>
                        </div>

                        <div class="status-update-section">
                            <h3>Update Status</h3>
                            <div class="form-group">
                                <label for="status-select">New Status:</label>
                                <select 
                                    id="status-select" 
                                    [(ngModel)]="selectedStatus" 
                                    name="selectedStatus"
                                    class="status-select"
                                    required>
                                    <option value="">Select New Status</option>
                                    <option *ngFor="let status of statusOptions" [value]="status.value">
                                        {{ status.label }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" (click)="updatePRStatus()" [disabled]="!selectedStatus">
                            <i class="fas fa-save"></i> Update Status
                        </button>
                        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal for View PR Details -->
            <div class="modal-overlay" *ngIf="isViewModalOpen" (click)="closeViewModal()">
                <div class="modal-content" (click)="$event.stopPropagation()">
                    <div class="modal-header">
                        <h2>Purchase Request Details</h2>
                        <button class="close-btn" (click)="closeViewModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="modal-body" *ngIf="currentViewingPR">
                        <div class="pr-details-view">
                            <div class="detail-section">
                                <h3><i class="fas fa-id-card"></i> Basic Information</h3>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>PR ID:</strong>
                                        <span>{{ currentViewingPR.prId }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Event ID:</strong>
                                        <span>{{ currentViewingPR.eventId }} - {{ getEventName(currentViewingPR.eventId) }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Vendor ID:</strong>
                                        <span>{{ currentViewingPR.vendorId }} - {{ getVendorName(currentViewingPR.vendorId) }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Request Date:</strong>
                                        <span>{{ currentViewingPR.requestLocalDate }}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h3><i class="fas fa-dollar-sign"></i> Financial Information</h3>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>Allocated Amount:</strong>
                                        <span class="amount-highlight">₹{{ currentViewingPR.allocatedamount | number:'1.2-2' }}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h3><i class="fas fa-info-circle"></i> Status Information</h3>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>Current Status:</strong>
                                        <span class="status-badge" 
                                              [ngClass]="{
                                                'pending': currentViewingPR.prstatus === 'PENDING',
                                                'in-negotiation': currentViewingPR.prstatus === 'IN_NEGOTIATION',
                                                'approved': currentViewingPR.prstatus === 'APPROVED',
                                                'rejected': currentViewingPR.prstatus === 'REJECTED'
                                              }">
                                            {{ currentViewingPR.prstatus }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h3><i class="fas fa-cogs"></i> Actions</h3>
                                <div class="action-buttons-modal">
                                    <button class="btn btn-info" (click)="navigateToNegotiate(currentViewingPR); closeViewModal()">
                                        <i class="fas fa-comments"></i> Start Negotiation
                                    </button>
                                    <button class="btn btn-warning" (click)="openEditModal(currentViewingPR); closeViewModal()">
                                        <i class="fas fa-edit"></i> Edit Status
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="closeViewModal()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>